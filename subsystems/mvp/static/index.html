<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MVP Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #e0e0e0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .game-display {
            flex: 1;
            background: #2a2a2a;
            border: 2px solid #444;
            border-radius: 8px;
            padding: 20px;
            overflow: auto;
            margin-bottom: 20px;
        }

        .terrain-view {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6.25px;
            max-width: 312.5px;
            margin: 0 auto;
        }

        .terrain-cell {
            aspect-ratio: 1;
            border: 1px solid #555;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            background: #333;
            position: relative;
        }

        .terrain-cell.current {
            border-color: #4a9eff;
            border-width: 2px;
            box-shadow: 0 0 5px rgba(74, 158, 255, 0.5);
        }

        .land-view {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 2px;
            max-width: 320px;
            margin: 0 auto;
        }

        .tile-cell {
            aspect-ratio: 1;
            border: 1px solid #555;
            border-radius: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            background: #333;
            position: relative;
        }

        .tile-cell.current {
            border-color: #4a9eff;
            border-width: 2px;
            box-shadow: 0 0 4px rgba(74, 158, 255, 0.5);
        }

        .character-sprite {
            position: absolute;
            width: 80%;
            height: 80%;
            top: 10%;
            left: 10%;
            object-fit: contain;
            z-index: 10;
            pointer-events: none;
        }

        .character-stats {
            background: #333;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .character-stats h3 {
            margin-bottom: 10px;
            color: #4a9eff;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 16px;
            font-weight: bold;
        }

        .health-bar-container {
            width: 100%;
            height: 20px;
            background: #1a1a1a;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
        }

        .health-bar {
            height: 100%;
            transition: width 0.3s ease, background-color 0.3s ease;
            border-radius: 10px;
        }

        .health-bar.high {
            background: #51cf66; /* Green */
        }

        .health-bar.medium {
            background: #ffd43b; /* Yellow */
        }

        .health-bar.low {
            background: #ff6b6b; /* Red */
        }

        .status-bar {
            background: #2a2a2a;
            border: 2px solid #444;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .status-bar h2 {
            margin-bottom: 10px;
            color: #4a9eff;
        }

        .status-info {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            flex-direction: column;
        }

        .status-label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
        }

        .status-value {
            font-size: 18px;
            font-weight: bold;
        }

        .command-section {
            display: flex;
            gap: 10px;
        }

        .command-input {
            flex: 1;
            background: #2a2a2a;
            border: 2px solid #444;
            border-radius: 8px;
            padding: 15px;
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
            font-size: 16px;
        }

        .command-input:focus {
            outline: none;
            border-color: #4a9eff;
        }

        .command-button {
            background: #4a9eff;
            border: none;
            border-radius: 8px;
            padding: 15px 30px;
            color: white;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
        }

        .command-button:hover {
            background: #5aaeff;
        }

        .command-button:active {
            background: #3a8eef;
        }

        .sidebar {
            width: 300px;
            background: #2a2a2a;
            border-left: 2px solid #444;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .history-section {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .history-section h3 {
            margin-bottom: 10px;
            color: #4a9eff;
        }

        .history-item {
            padding: 8px;
            margin-bottom: 5px;
            background: #333;
            border-radius: 4px;
            font-size: 12px;
            border-left: 3px solid #4a9eff;
        }

        .history-command {
            color: #4a9eff;
            font-weight: bold;
        }

        .history-response {
            color: #888;
            margin-top: 4px;
        }

        .help-section {
            background: #333;
            border-radius: 8px;
            padding: 15px;
        }

        .help-section h3 {
            margin-bottom: 10px;
            color: #4a9eff;
        }

        .help-section code {
            background: #1a1a1a;
            padding: 2px 6px;
            border-radius: 3px;
            color: #4a9eff;
        }

        .error {
            color: #ff6b6b;
        }

        .success {
            color: #51cf66;
        }

        .message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            background: #333;
            min-height: 20px;
        }
        
        .message:empty {
            padding: 0;
            margin-top: 0;
            min-height: 0;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="status-bar">
            <h2>Game Status</h2>
            <div class="status-info">
                <div class="status-item">
                    <span class="status-label">View Mode</span>
                    <span class="status-value" id="view-mode">Loading...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Current Land</span>
                    <span class="status-value" id="current-land">Loading...</span>
                </div>
                <div class="status-item" id="biome-item" style="display: none;">
                    <span class="status-label">Biome</span>
                    <span class="status-value" id="current-biome">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Current Tile</span>
                    <span class="status-value" id="current-tile">-</span>
                </div>
            </div>
            <div class="status-info" id="tile-info-section" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #444;">
                <div class="status-item">
                    <span class="status-label">Biome</span>
                    <span class="status-value" id="tile-biome">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Substrate</span>
                    <span class="status-value" id="tile-substrate">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Objects</span>
                    <span class="status-value" id="tile-objects">-</span>
                </div>
            </div>
        </div>

        <div class="game-display" id="game-display">
            <div style="text-align: center; padding: 40px; color: #888;">
                Loading game state...
            </div>
        </div>

        <div class="command-section">
            <input 
                type="text" 
                class="command-input" 
                id="command-input" 
                placeholder="Enter command (U/D/L/R/E/X/HELP)"
                autocomplete="off"
            />
            <button class="command-button" id="command-button">Execute</button>
        </div>

        <div class="message" id="message"></div>
    </div>

        <div class="sidebar">
        <div class="character-stats">
            <h3>Character Stats</h3>
            <div class="stat-row">
                <span class="stat-label">Health</span>
                <span class="stat-value" id="character-health">-</span>
            </div>
            <div class="health-bar-container">
                <div class="health-bar" id="health-bar"></div>
            </div>
            <div class="stat-row" style="margin-top: 10px;">
                <span class="stat-label">Attack</span>
                <span class="stat-value" id="character-attack">-</span>
            </div>
        </div>

        <div class="history-section">
            <h3>Command History</h3>
            <div id="history-list"></div>
        </div>

        <div class="help-section">
            <h3>Commands</h3>
            <p><code>U</code> - Move Up</p>
            <p><code>D</code> - Move Down</p>
            <p><code>L</code> - Move Left</p>
            <p><code>R</code> - Move Right</p>
            <p><code>E</code> - Enter Land</p>
            <p><code>X</code> - Exit Land</p>
            <p><code>H</code> - Help</p>
        </div>
    </div>

    <script>
        let gameState = null;
        let commandHistory = [];

        // Load initial game state
        async function loadGameState() {
            try {
                const response = await fetch('/api/state');
                const data = await response.json();
                gameState = data;
                renderGame();
                updateStatus();
            } catch (error) {
                console.error('Failed to load game state:', error);
                showMessage('Failed to load game state', 'error');
            }
        }

        // Execute a command
        async function executeCommand(command) {
            if (!command.trim()) return;

            try {
                const response = await fetch('/api/command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ command: command.trim() }),
                });

                const data = await response.json();
                gameState = data.game_state;

                // Add to history
                commandHistory.push({
                    command: command.trim(),
                    response: data.message,
                    success: data.success,
                });
                if (commandHistory.length > 50) {
                    commandHistory.shift();
                }

                renderHistory();
                renderGame();
                updateStatus();
                showMessage(data.message, data.success ? 'success' : 'error');
            } catch (error) {
                console.error('Failed to execute command:', error);
                showMessage('Failed to execute command', 'error');
            }
        }

        // Render the game display
        function renderGame() {
            const display = document.getElementById('game-display');
            
            if (gameState.view_mode === 'Terrain') {
                display.innerHTML = '<div class="terrain-view" id="terrain-grid"></div>';
                renderTerrainView();
            } else {
                display.innerHTML = '<div class="land-view" id="land-grid"></div>';
                renderLandView();
            }
        }

        // Render terrain view (5x5 grid)
        function renderTerrainView() {
            const grid = document.getElementById('terrain-grid');
            const [charLandX, charLandY] = gameState.character.land_position;

            for (let y = 0; y < 5; y++) {
                for (let x = 0; x < 5; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'terrain-cell';
                    
                    const [currentX, currentY] = gameState.current_land;
                    if (x === currentX && y === currentY) {
                        cell.classList.add('current');
                    }

                    const landKey = `${x},${y}`;
                    const land = gameState.world.terrain[landKey];
                    
                    if (land) {
                        const color = getBiomeColor(land.center);
                        cell.style.backgroundColor = rgbToCss(color);
                        cell.textContent = ''; // No emoji, just color
                        cell.title = `Land (${x}, ${y}): ${land.center}`;
                    } else {
                        cell.style.backgroundColor = '#1a1a1a'; // Dark background for ungenerated
                        cell.textContent = '';
                        cell.title = `Ungenerated (${x}, ${y})`;
                    }

                    // Add character sprite if character is on this land
                    if (x === charLandX && y === charLandY) {
                        const sprite = document.createElement('img');
                        sprite.className = 'character-sprite';
                        sprite.src = '/assets/viking_player.png';
                        sprite.alt = 'Character';
                        cell.appendChild(sprite);
                    }

                    grid.appendChild(cell);
                }
            }
        }

        // Render land view (8x8 grid)
        function renderLandView() {
            const grid = document.getElementById('land-grid');
            const [landX, landY] = gameState.current_land;
            const [tileX, tileY] = gameState.current_tile || [0, 0];
            const charTilePos = gameState.character.tile_position;

            const landKey = `${landX},${landY}`;
            const land = gameState.world.terrain[landKey];

            if (!land) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #888;">Land not found</div>';
                return;
            }

            for (let y = 0; y < 8; y++) {
                for (let x = 0; x < 8; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'tile-cell';
                    
                    if (x === tileX && y === tileY) {
                        cell.classList.add('current');
                    }

                    const tile = land.tiles[y][x];
                    
                    // Use substrate color as base background
                    let backgroundColor = getSubstrateColor(tile.substrate);
                    cell.style.backgroundColor = rgbToCss(backgroundColor);
                    
                    // If there are objects, display the object image
                    if (tile.objects && tile.objects.length > 0) {
                        const object = tile.objects[0];
                        const assetFile = getObjectAsset(object);
                        
                        if (assetFile) {
                            const img = document.createElement('img');
                            img.src = `/assets/${assetFile}`;
                            img.style.width = '100%';
                            img.style.height = '100%';
                            img.style.objectFit = 'contain';
                            img.alt = object;
                            cell.appendChild(img);
                        } else {
                            // Fallback to color if asset not found
                            cell.style.backgroundColor = rgbToCss(getObjectColor(object));
                        }
                    }
                    
                    // Add character sprite if character is on this tile
                    if (charTilePos && x === charTilePos[0] && y === charTilePos[1]) {
                        const sprite = document.createElement('img');
                        sprite.className = 'character-sprite';
                        sprite.src = '/assets/viking_player.png';
                        sprite.alt = 'Character';
                        cell.appendChild(sprite);
                    }
                    
                    cell.title = `Tile (${x}, ${y}): ${tile.substrate}${tile.objects.length > 0 ? ' + ' + tile.objects[0] : ''}`;

                    grid.appendChild(cell);
                }
            }
        }

        // Helper functions for rendering colors (matching main Q game)
        function getBiomeColor(biome) {
            const biomeMap = {
                'Forest': [0.1, 0.5, 0.1],         // Dark green
                'Meadow': [0.7, 0.9, 0.4],         // Light green/yellow
                'Lake': [0.2, 0.5, 0.9],           // Blue
                'Mountain': [0.8, 0.8, 0.85],      // Gray/white
                'Plains': [0.6, 0.5, 0.35],        // Brown/tan
            };
            return biomeMap[biome] || [0.5, 0.5, 0.5];
        }

        function getSubstrateColor(substrate) {
            const substrateMap = {
                'Grass': [0.7, 0.9, 0.4],      // Light green/yellow
                'Dirt': [0.6, 0.4, 0.2],       // Brown
                'Stone': [0.7, 0.7, 0.7],      // Gray
                'Mud': [0.4, 0.3, 0.2],        // Dark brown
                'Water': [0.2, 0.4, 0.9],      // Blue
                'Brush': [0.2, 0.6, 0.15],    // Dark green
            };
            return substrateMap[substrate] || [0.5, 0.5, 0.5];
        }

        function getObjectColor(object) {
            const objectMap = {
                'Rock': [0.3, 0.3, 0.3],          // Dark gray
                'Tree': [0.1, 0.6, 0.1],          // Green
                'Stick': [0.5, 0.3, 0.1],         // Brown
            };
            return objectMap[object] || [0.5, 0.5, 0.5];
        }

        // Map Object enum values to asset filenames from parent project
        function getObjectAsset(object) {
            const assetMap = {
                'Rock': 'boulder.png',
                'Tree': 'tree.png',
                'Stick': 'stick.png',
            };
            return assetMap[object] || null;
        }

        // Convert RGB (0.0-1.0) to CSS color string
        function rgbToCss(rgb) {
            const [r, g, b] = rgb;
            return `rgb(${Math.round(r * 255)}, ${Math.round(g * 255)}, ${Math.round(b * 255)})`;
        }

        // Update status bar
        function updateStatus() {
            document.getElementById('view-mode').textContent = gameState.view_mode;
            document.getElementById('current-land').textContent = 
                `(${gameState.current_land[0]}, ${gameState.current_land[1]})`;
            
            if (gameState.current_tile) {
                document.getElementById('current-tile').textContent = 
                    `(${gameState.current_tile[0]}, ${gameState.current_tile[1]})`;
            } else {
                document.getElementById('current-tile').textContent = '-';
            }

            // Show biome in Terrain view
            const biomeItem = document.getElementById('biome-item');
            if (gameState.view_mode === 'Terrain' && gameState.current_biome) {
                document.getElementById('current-biome').textContent = gameState.current_biome;
                biomeItem.style.display = 'flex';
            } else {
                biomeItem.style.display = 'none';
            }

            // Update tile information if available (Land view)
            const tileInfoSection = document.getElementById('tile-info-section');
            if (gameState.current_tile_info) {
                const info = gameState.current_tile_info;
                document.getElementById('tile-biome').textContent = info.biome;
                document.getElementById('tile-substrate').textContent = info.substrate;
                
                if (info.objects && info.objects.length > 0) {
                    document.getElementById('tile-objects').textContent = info.objects.join(', ');
                } else {
                    document.getElementById('tile-objects').textContent = 'None';
                }
                
                tileInfoSection.style.display = 'flex';
            } else {
                tileInfoSection.style.display = 'none';
            }

            // Update character stats
            if (gameState.character) {
                const char = gameState.character;
                document.getElementById('character-health').textContent = `${char.health}/${char.max_health}`;
                document.getElementById('character-attack').textContent = char.attack.toString();

                // Update health bar
                const healthBar = document.getElementById('health-bar');
                const healthPercent = (char.health / char.max_health) * 100;
                healthBar.style.width = `${healthPercent}%`;

                // Set health bar color based on percentage
                healthBar.className = 'health-bar';
                if (healthPercent > 60) {
                    healthBar.classList.add('high');
                } else if (healthPercent > 30) {
                    healthBar.classList.add('medium');
                } else {
                    healthBar.classList.add('low');
                }
            }
        }

        // Render command history
        function renderHistory() {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';

            if (commandHistory.length === 0) {
                historyList.innerHTML = '<div style="color: #888; font-style: italic;">No commands yet</div>';
                return;
            }

            // Show most recent first
            const reversed = [...commandHistory].reverse();
            reversed.forEach(item => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
                    <div class="history-command">${item.command}</div>
                    <div class="history-response ${item.success ? 'success' : 'error'}">${item.response}</div>
                `;
                historyList.appendChild(div);
            });
        }

        // Show message (permanently visible)
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
            // Message stays visible permanently - no auto-hide
        }

        // Set up event listeners
        document.getElementById('command-button').addEventListener('click', () => {
            const input = document.getElementById('command-input');
            executeCommand(input.value);
            input.value = '';
        });

        document.getElementById('command-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const input = document.getElementById('command-input');
                executeCommand(input.value);
                input.value = '';
            }
        });

        // Arrow key shortcuts for movement
        document.addEventListener('keydown', (e) => {
            // Map arrow keys to movement commands
            const arrowKeyMap = {
                'ArrowUp': 'U',
                'ArrowDown': 'D',
                'ArrowLeft': 'L',
                'ArrowRight': 'R',
            };
            
            const command = arrowKeyMap[e.key];
            if (command) {
                e.preventDefault(); // Prevent default arrow key behavior (scrolling, etc.)
                executeCommand(command);
            }
        });

        // Focus command input on load
        document.getElementById('command-input').focus();

        // Load initial state
        loadGameState();
    </script>
</body>
</html>
